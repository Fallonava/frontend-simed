# üîÑ Safe Database Migration Guide (Production)

## ‚ö†Ô∏è CRITICAL: Never Use These Commands on Production

```bash
# ‚ùå DANGER - Will delete all data!
npx prisma migrate reset
npx prisma migrate dev --create-only
npx prisma db push --force-reset

# ‚ùå These commands are for DEVELOPMENT ONLY
```

---

## ‚úÖ Safe Migration Workflow (Production)

### Step 1: Create Migration Locally (Development)

```powershell
# On your local Windows machine
cd F:\PROJECT\frontend-simed-1\backend

# Generate migration from schema changes
npx prisma migrate dev --name add_tte_and_pacs_fields

# This will:
# 1. Create SQL migration file in /prisma/migrations/
# 2. Apply it to your local database
# 3. Generate Prisma Client
```

**Important**: The migration file will be created in `backend/prisma/migrations/YYYYMMDDHHMMSS_add_tte_and_pacs_fields/migration.sql`

### Step 2: Commit & Push Migration to GitHub

```powershell
# From project root
git add backend/prisma/migrations/
git add backend/prisma/schema.prisma
git commit -m "feat: Add TTE and PACS fields to database schema"
git push origin main
```

### Step 3: Pull Latest Code on Server

```powershell
# Connect to server
ssh -i .\hospital-api.pem ubuntu@16.79.196.134

# On server - pull latest code
cd /var/www/simrs  # Adjust to your actual deployment path
git pull origin main
```

### Step 4: Apply Migration Safely (Production)

```bash
# Still on server
cd backend

# Install dependencies if needed
npm install

# üî• SAFE COMMAND - Only applies pending migrations
npx prisma migrate deploy

# This will:
# ‚úÖ Apply new migrations WITHOUT resetting database
# ‚úÖ Keep all existing data intact
# ‚úÖ Only add new tables/columns as defined in migrations
```

### Step 5: Regenerate Prisma Client

```bash
# On server
npx prisma generate
```

### Step 6: Restart Application

```bash
# If using PM2
pm2 restart all

# Or restart specific app
pm2 restart simrs-backend

# Check status
pm2 status
pm2 logs simrs-backend --lines 50
```

---

## üö® Emergency Rollback

If migration causes issues:

### Option 1: Rollback to Previous Migration (Prisma 5.0+)

```bash
# Check migration history
npx prisma migrate status

# Rollback last migration
npx prisma migrate resolve --rolled-back "YYYYMMDDHHMMSS_migration_name"
```

### Option 2: Manual Database Restore

```bash
# Restore from backup (if you have one)
pg_restore -U simrs_user -d simrs_production /path/to/backup.sql
```

### Option 3: Cherry-pick Revert Commit

```bash
# On server
git log --oneline
git revert <commit-hash>
git push origin main
```

---

## üìä Current Schema Changes Pending

Based on recent development, these fields were added:

### MedicalRecord Table
```prisma
model MedicalRecord {
  // ... existing fields ...
  
  // TTE (Electronic Signature)
  is_signed     Boolean  @default(false)
  signed_at     DateTime?
  tte_metadata  Json?    // Store BSRE/Privy response
}
```

### ServiceOrder Table
```prisma
model ServiceOrder {
  // ... existing fields ...
  
  // PACS Integration
  result_image_url  String?       // For quick preview
  dicom_study_id    String?       // Link to internal/external PACS
}
```

**Migration SQL Preview** (Auto-generated by Prisma):
```sql
-- AlterTable MedicalRecord
ALTER TABLE "MedicalRecord" 
  ADD COLUMN "is_signed" BOOLEAN NOT NULL DEFAULT false,
  ADD COLUMN "signed_at" TIMESTAMP(3),
  ADD COLUMN "tte_metadata" JSONB;

-- AlterTable ServiceOrder
ALTER TABLE "ServiceOrder" 
  ADD COLUMN "result_image_url" TEXT,
  ADD COLUMN "dicom_study_id" TEXT;
```

---

## üîç Pre-Migration Checklist

Before running migration on production:

- [ ] ‚úÖ **Backup database** first!
  ```bash
  pg_dump -U simrs_user simrs_production > backup_$(date +%Y%m%d_%H%M%S).sql
  ```
- [ ] ‚úÖ Test migration on **staging environment** first
- [ ] ‚úÖ Verify migration SQL doesn't have `DROP TABLE` or `DROP COLUMN`
- [ ] ‚úÖ Check that migration is **additive only** (adds tables/columns, doesn't remove)
- [ ] ‚úÖ Ensure database user has **ALTER TABLE** permissions
- [ ] ‚úÖ Schedule migration during **low-traffic hours** (if possible)
- [ ] ‚úÖ Notify team about maintenance window

---

## üõ°Ô∏è Database Backup (Before Migration)

### Manual Backup

```bash
# On server
sudo -u postgres pg_dump simrs_production > ~/backups/simrs_backup_$(date +%Y%m%d_%H%M%S).sql

# Verify backup
ls -lh ~/backups/

# Compress backup (optional)
gzip ~/backups/simrs_backup_*.sql
```

### Automated Daily Backup (Recommended)

```bash
# Create backup script
sudo nano /usr/local/bin/backup-simrs-db.sh
```

```bash
#!/bin/bash
BACKUP_DIR="/home/ubuntu/backups"
TIMESTAMP=$(date +%Y%m%d_%H%M%S)
DB_NAME="simrs_production"
DB_USER="simrs_user"

mkdir -p $BACKUP_DIR

# Create backup
sudo -u postgres pg_dump $DB_NAME > "$BACKUP_DIR/simrs_$TIMESTAMP.sql"

# Compress
gzip "$BACKUP_DIR/simrs_$TIMESTAMP.sql"

# Keep only last 7 days
find $BACKUP_DIR -name "simrs_*.sql.gz" -mtime +7 -delete

echo "Backup completed: simrs_$TIMESTAMP.sql.gz"
```

```bash
# Make executable
sudo chmod +x /usr/local/bin/backup-simrs-db.sh

# Add to crontab (daily at 2 AM)
crontab -e
# Add this line:
0 2 * * * /usr/local/bin/backup-simrs-db.sh >> /var/log/simrs-backup.log 2>&1
```

---

## üìù Full Migration Execution (Copy-Paste Ready)

```bash
# === ON SERVER (via SSH) ===

# 1. Backup database
sudo -u postgres pg_dump simrs_production > ~/simrs_backup_$(date +%Y%m%d_%H%M%S).sql

# 2. Navigate to app directory
cd /var/www/simrs

# 3. Pull latest code
git pull origin main

# 4. Navigate to backend
cd backend

# 5. Install dependencies (if package.json changed)
npm install

# 6. Apply migrations safely
npx prisma migrate deploy

# 7. Regenerate Prisma Client
npx prisma generate

# 8. Restart application
pm2 restart all

# 9. Check logs
pm2 logs --lines 100

# 10. Verify migration status
npx prisma migrate status
```

---

## ‚úÖ Verification After Migration

```bash
# Check if new columns exist
psql -U simrs_user -d simrs_production -c "\d \"MedicalRecord\""
psql -U simrs_user -d simrs_production -c "\d \"ServiceOrder\""

# Check data integrity (sample query)
psql -U simrs_user -d simrs_production -c "SELECT COUNT(*) FROM \"MedicalRecord\";"

# Test application health
curl http://localhost:3000/api/health
```

---

## üîó Additional Resources

- [Prisma Migrate Documentation](https://www.prisma.io/docs/concepts/components/prisma-migrate)
- [Production Migrations Guide](https://www.prisma.io/docs/guides/migrate/production-troubleshooting)
- [Database Backup Best Practices](https://www.postgresql.org/docs/current/backup.html)

---

**Last Updated**: 2025-12-23  
**Maintained By**: Development Team
