generator client {
  provider = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-1.1.x", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Poliklinik {
  id         Int      @id @default(autoincrement())
  name       String
  queue_code String   @unique
  doctors    Doctor[]
}

model Doctor {
  id            Int        @id @default(autoincrement())
  name          String
  specialist    String
  photo_url     String?
  poliklinik_id Int
  poliklinik    Poliklinik @relation(fields: [poliklinik_id], references: [id])
  DailyQuota    DailyQuota[]
  schedules     DoctorSchedule[]
  leaves        DoctorLeave[]
  medical_records MedicalRecord[]
  prescriptions Prescription[]
}

model DoctorLeave {
  id        Int      @id @default(autoincrement())
  doctor_id Int
  doctor    Doctor   @relation(fields: [doctor_id], references: [id])
  date      DateTime
  reason    String?
  created_at DateTime @default(now())

  @@unique([doctor_id, date])
}

model DoctorSchedule {
  id        Int    @id @default(autoincrement())
  doctor_id Int
  doctor    Doctor @relation(fields: [doctor_id], references: [id], onDelete: Cascade)
  day       Int    // 1=Senin, 2=Selasa, etc.
  time      String // e.g. "08.00 - 12.00"
}

model DailyQuota {
  id            Int         @id @default(autoincrement())
  doctor_id     Int
  doctor        Doctor      @relation(fields: [doctor_id], references: [id])
  date          DateTime
  max_quota     Int
  current_count Int         @default(0)
  status        String      @default("OPEN") // OPEN, CLOSED, FULL, BREAK
  queues        Queue[]

  @@unique([doctor_id, date])
}


model Queue {
  id             Int         @id @default(autoincrement())
  daily_quota_id Int
  daily_quota    DailyQuota  @relation(fields: [daily_quota_id], references: [id])
  patient_id     Int?        // Link to Patient (Optional for transition)
  patient        Patient?    @relation(fields: [patient_id], references: [id])
  queue_number   Int
  queue_code     String
  status         String      @default("WAITING") // WAITING, CALLED, SERVED, SKIPPED
  created_at     DateTime    @default(now())
  medical_records MedicalRecord[]
}

model Patient {
  id          Int      @id @default(autoincrement())
  nik         String   @unique
  no_rm       String   @unique // 00-00-01
  name        String
  gender      String   // L/P
  birth_date  DateTime
  address     String?
  phone       String?
  email       String?
  allergies   String?  @db.Text
  
  // BPJS Data
  bpjs_card_no String? @unique
  is_bpjs      Boolean @default(false)
  
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt
  queues      Queue[]
  medical_records MedicalRecord[]
  prescriptions Prescription[]
  transactions Transaction[]
}

model Sequence {
  id    Int    @id @default(autoincrement())
  key   String @unique // e.g. "medical_record"
  value Int    @default(0)
}

model User {
  id       Int    @id @default(autoincrement())
  username String @unique
  password String
  role     String // ADMIN, STAFF
}

model Counter {
  id        Int      @id @default(autoincrement())
  name      String   @unique
  status    String   @default("CLOSED") // OPEN, CLOSED, BUSY
  createdAt DateTime @default(now())
}

model Playlist {
  id        Int      @id @default(autoincrement())
  type      String   // "VIDEO" or "IMAGE"
  url       String   // YouTube ID or Image URL
  duration  Int      @default(10) // Duration in seconds (for images)
  order     Int      @default(0)
  isActive  Boolean  @default(true)
  created_at DateTime @default(now())
}

model Setting {
  id        Int      @id @default(autoincrement())
  key       String   @unique
  value     String
  updatedAt DateTime @updatedAt
}

model MedicalRecord {
  id          Int      @id @default(autoincrement())
  patient_id  Int
  patient     Patient  @relation(fields: [patient_id], references: [id])
  doctor_id   Int
  doctor      Doctor   @relation(fields: [doctor_id], references: [id])
  queue_id    Int?     // Optional link to specific queue ticket
  queue       Queue?   @relation(fields: [queue_id], references: [id])
  visit_date  DateTime @default(now())
  
  // Vitals (SOP Standard)
  systolic    Int?
  diastolic   Int?
  heart_rate  Int?
  temperature Float?
  weight      Float?
  height      Float?

  // SOAP
  subjective  String   @db.Text // Keluhan
  objective   String   @db.Text // Pemeriksaan Fisik
  assessment  String   @db.Text // Diagnosa
  plan        String   @db.Text // Tindakan/Resep
  
  // New: Clinical Safety & Standards
  triage_status String   @default("PENDING") // PENDING, COMPLETED, SKIPPED
  icd10_code    String?
  icd10         ICD10?   @relation(fields: [icd10_code], references: [code])
  
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt // Fixed: Use @updatedAt here if desired, or manually manage
  prescriptions Prescription[]
  transaction   Transaction?
  service_orders ServiceOrder[]
}

model ICD10 {
  code        String   @id
  name        String
  description String?
  medical_records MedicalRecord[]
}

model ServiceOrder {
  id                Int           @id @default(autoincrement())
  medical_record_id Int
  medical_record    MedicalRecord @relation(fields: [medical_record_id], references: [id])
  type              String        // LAB, RAD
  status            String        @default("PENDING") // PENDING, IN_PROGRESS, COMPLETED
  notes             String?
  result            String?       // URL or Text result
  
  created_at        DateTime      @default(now())
  updated_at        DateTime      @updatedAt
}

model Medicine {
  id        Int      @id @default(autoincrement())
  name      String
  code      String   @unique
  category  String?  // Tablet, Syrup, Injection
  stock     Int      @default(0)
  unit      String   // strips, bottles, pcs
  price     Float    @default(0)
  expiry    DateTime?
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt
  
  prescription_items PrescriptionItem[]
}

model Prescription {
  id              Int      @id @default(autoincrement())
  medical_record_id Int
  medical_record  MedicalRecord @relation(fields: [medical_record_id], references: [id])
  doctor_id       Int
  doctor          Doctor   @relation(fields: [doctor_id], references: [id])
  patient_id      Int
  patient         Patient  @relation(fields: [patient_id], references: [id])
  
  status          String   @default("PENDING") // PENDING, PREPARING, COMPLETED, CANCELLED
  notes           String?
  
  created_at      DateTime @default(now())
  updated_at      DateTime @updatedAt
  
  items           PrescriptionItem[]
}

model PrescriptionItem {
  id              Int      @id @default(autoincrement())
  prescription_id Int
  prescription    Prescription @relation(fields: [prescription_id], references: [id], onDelete: Cascade)
  medicine_id     Int
  medicine        Medicine @relation(fields: [medicine_id], references: [id])
  
  quantity        Int
  dosage          String   // e.g. "3x1 after meal"
  notes           String?
}

model Transaction {
  id              Int      @id @default(autoincrement())
  invoice_no      String   @unique // INV/YYYYMMDD/001
  medical_record_id Int    @unique // One transaction per visit
  medical_record  MedicalRecord @relation(fields: [medical_record_id], references: [id])
  patient_id      Int
  patient         Patient  @relation(fields: [patient_id], references: [id])
  
  total_amount    Float
  status          String   @default("UNPAID") // UNPAID, PAID, CANCELLED
  payment_method  String?  // CASH, QRIS, TRANSFER
  
  created_at      DateTime @default(now())
  updated_at      DateTime @updatedAt
  
  items           TransactionItem[]
}

model TransactionItem {
  id              Int      @id @default(autoincrement())
  transaction_id  Int
  transaction     Transaction @relation(fields: [transaction_id], references: [id], onDelete: Cascade)
  description     String   // "Jasa Dokter", "Paracetamol", "Biaya Daftar"
  amount          Float
  quantity        Int      @default(1)
}
